# AgiLLM Fractal Protocol: Technical Specification v1.0

## Executive Summary: The Intelligence Layer Expansion

Building on 100% byte-parity achievement, we now transition from **serialization** to **protocol specialization**. This document defines the "Iron Mold" specifications for implementing the Fractal Protocol across Python/Rust engines.

**Status:** Specification APPROVED - Ready for Implementation
**Target:** v2.0.0 - v2.3.0
**Created:** 2025-12-20
**Authors:** Multi-AI Collaboration (Claude.ai Architect, AI Studio Analyst)

---

## Implementation Phases

| Phase | Version | Feature | Status |
|-------|---------|---------|--------|
| 1 | v2.0.0 | Protocol Adapters (Claude-XML) | **[IMPLEMENTED]** |
| 2 | v2.1.0 | Fractal Zoom | **[IMPLEMENTED]** |
| 3 | v2.2.0 | Context Store v2 | Planned |
| 4 | v2.3.0 | MCP Integration | **[IMPLEMENTED]** |

### Implementation Notes (rust-v1.0.0)

**Phase 1 - Protocol Adapters:**
- `--format claude-xml` with full metadata and attention_map
- `--frozen` flag for deterministic output
- `--allow-sensitive` flag for privacy control
- CDATA escaping handles all `]]>` sequences

**Phase 2 - Fractal Zoom:**
- `--zoom fn=<name>` to zoom into functions
- `--zoom class=<name>` to zoom into classes/structs
- `--zoom mod=<name>` to zoom into modules
- `--zoom file=<path>:L1-L2` to zoom into file line ranges
- ZOOM_AFFORDANCE markers embedded in truncation output

**Phase 4 - MCP Integration:**
- `zoom_context` tool added to MCP server
- Supports target_type, target_name, line_range, depth parameters

---

## FOUNDATIONAL PROTOCOLS

### Context-Anchor Protocol

The Context-Anchor Protocol enables AI agents to autonomously request deeper context during conversations.

**Authorization Mechanism:**
When an AI agent encounters a `<zoom>` tag within the serialized context, it is **explicitly authorized** to call the `zoom_context` tool to expand that section. This creates a contract between the context producer (pm_encoder) and the context consumer (AI agent).

**Zoom Tag Specification:**
```xml
<zoom type="function" target="apply_token_budget" budget="500"
      command="pm_encoder --zoom function=apply_token_budget --budget=500" />
```

**Agent Behavior:**
1. Agent identifies a `<zoom>` affordance in the context
2. Agent determines if expansion would help answer the current query
3. Agent calls `zoom_context` tool with the specified parameters
4. pm_encoder returns the expanded context fragment
5. Agent integrates the fragment into its understanding

**MCP Tool Definition:**
```json
{
  "name": "zoom_context",
  "description": "Expand a specific code section from the current context",
  "inputSchema": {
    "type": "object",
    "properties": {
      "type": {"type": "string", "enum": ["function", "class", "module", "file"]},
      "target": {"type": "string", "description": "Identifier of the element to expand"},
      "budget": {"type": "number", "description": "Token budget for the expansion"},
      "depth": {"type": "string", "enum": ["signature", "implementation", "full"]}
    },
    "required": ["type", "target"]
  }
}
```

---

### Determinism Layer

The Determinism Layer ensures reproducible output for CI/CD pipelines and testing environments.

**The `--frozen` Flag:**

When `--frozen` is passed to pm_encoder, the engine operates in **deterministic mode**:

1. **Context Store Bypass:** All reads from `.pm_context_store.json` are skipped
2. **Static Priorities:** Only lens-defined priority groups are used (no learned priorities)
3. **No Side Effects:** No writes to context store, no feedback recording
4. **Fixed Timestamps:** Metadata timestamps use epoch (0) instead of current time
5. **Sorted Output:** Files are processed in deterministic alphabetical order

**Implementation:**
```rust
pub struct EncoderConfig {
    // ... existing fields ...

    /// Frozen mode: bypass context store for deterministic output
    /// Enables byte-identical output for CI/CD pipelines
    pub frozen: bool,
}
```

**CLI Usage:**
```bash
# Deterministic mode for CI testing
pm_encoder . --format claude-xml --frozen

# Normal mode with learning (default)
pm_encoder . --format claude-xml
```

**Guarantee:** Running the same command with `--frozen` on the same codebase will produce byte-identical output, enabling:
- Git diff-based change detection
- Snapshot testing in CI pipelines
- Reproducible bug reports

---

### Privacy Boundary

The Privacy Boundary ensures that sensitive information is not inadvertently included in serialized context.

**Default Behavior:**
The `<metadata>` section of Claude-XML output **must exclude**:
- Personally Identifiable Information (PII)
- API keys, tokens, or credentials
- Internal session notes or debugging comments
- User-specific file paths (normalized to relative paths)
- Hostname or machine identifiers

**Opt-In Sensitive Data:**
When explicit authorization is needed:

```bash
# Include session metadata and notes (for debugging)
pm_encoder . --format claude-xml --allow-sensitive
```

**Implementation:**
```rust
pub struct EncoderConfig {
    // ... existing fields ...

    /// Allow sensitive metadata in output (session notes, paths)
    /// Default: false for privacy protection
    pub allow_sensitive: bool,
}

impl ContextEngine {
    fn generate_metadata(&self) -> Metadata {
        if self.config.allow_sensitive {
            // Include full session data, paths, notes
            self.generate_full_metadata()
        } else {
            // Sanitized metadata only
            self.generate_sanitized_metadata()
        }
    }
}
```

**Sanitization Rules:**
| Field | Default | With `--allow-sensitive` |
|-------|---------|--------------------------|
| `project_root` | "." | Full absolute path |
| `hostname` | Omitted | Included |
| `session_notes` | Omitted | Included |
| `user_config_path` | Omitted | Included |
| `git_remote` | Origin domain only | Full URL |

---

## TASK 1: Protocol Adapter Design

### 1.1 Claude-Optimized XML Format (`--format claude-xml`)

```xml
<context package="pm_encoder" lens="architecture" token_budget="15000" utilized="14997">
  <metadata>
    <version>2.0.0</version>
    <frozen>false</frozen>
    <timestamp>2025-12-20T10:30:00Z</timestamp>

    <attention_map>
      <hotspot path="pm_coach/runner.py" priority="100" tokens="824" />
      <hotspot path="rust/src/lib.rs" priority="95" tokens="712" truncated="true" />
      <coldspot path="test_vectors/legacy.json" priority="10" tokens="11000" dropped="true" />
    </attention_map>

    <lens_config>
      <name>architecture</name>
      <strategy>hybrid</strategy>
      <truncated_files>12</truncated_files>
      <dropped_files>3</dropped_files>
    </lens_config>
  </metadata>

  <files>
    <file path="pm_coach/runner.py"
          priority="100"
          tokens="824"
          checksum="f42cad9516a162e3409e9e63d8ab3f41"
          language="python">
      <![CDATA[
class DifferentialRunner:
    """Runs Python and Rust pm_encoder and compares output."""

    def compare(self, source: RepoSource) -> RunResult:
        """Run both engines and compare output."""
        pass
      ]]>
    </file>

    <file path="rust/src/lib.rs"
          priority="95"
          tokens="712"
          checksum="abc123..."
          language="rust"
          truncated="true"
          original_tokens="26095">
      <![CDATA[
pub mod analyzers;
pub mod budgeting;
pub mod lenses;

pub trait LanguageAnalyzer {
    fn analyze(&self, content: &str) -> AnalysisResult;
}
      ]]>
    </file>
  </files>
</context>
```

### 1.2 CDATA Escaping

XML CDATA sections cannot contain the sequence `]]>`. When code contains this sequence, it must be split:

**Before (Invalid):**
```xml
<![CDATA[
let x = arr[arr.len() - 1]]>;  // This breaks CDATA!
]]>
```

**After (Valid):**
```xml
<![CDATA[
let x = arr[arr.len() - 1]]]]><![CDATA[>;  // Split across CDATA boundaries
]]>
```

**Implementation:**
```rust
fn escape_cdata(content: &str) -> String {
    content.replace("]]>", "]]]]><![CDATA[>")
}
```

---

## TASK 2: Fractal Protocol (Interactive Zoom)

### 2.1 Hyperlink/Affordance Syntax

**Truncation markers with zoom affordances:**
```xml
<truncation_marker>
  <message>Function body truncated: 42 lines â†’ signature only</message>
  <zoom type="function" target="apply_token_budget" budget="500"
        command="pm_encoder --zoom function=apply_token_budget --budget=500" />
</truncation_marker>
```

### 2.2 CLI Zoom Arguments

```bash
# Zoom into a specific function
pm_encoder --zoom function=apply_token_budget --module=budgeting --budget=500

# Zoom into a module
pm_encoder --zoom module=analyzers --depth=full --include-tests

# Zoom into a file section
pm_encoder --zoom file=pm_coach/runner.py --lines=100-200 --context=50
```

---

## TASK 3: Context Store v2

### 3.1 Enhanced Store Schema

The Context Store tracks file utility across sessions for adaptive prioritization.

**Location:** `.pm_context_store.json`

**Schema:**
```json
{
  "version": "2.0.0",
  "files": {
    "path/to/file.py": {
      "utility_score": 0.85,
      "access_count": 47,
      "last_accessed": "2025-12-20T10:28:00Z",
      "tags": ["core", "testing"]
    }
  },
  "lens_profiles": {
    "architecture": {
      "learned_priorities": {},
      "effectiveness_score": 0.87
    }
  }
}
```

### 3.2 Feedback Loop

AI agents can provide feedback to improve future context generation:

```json
{
  "method": "context/feedback",
  "params": {
    "session_id": "claude_2025-12-20",
    "file_ratings": {
      "pm_coach/runner.py": {"utility": 0.95, "reason": "Critical for understanding parity"}
    },
    "overall_effectiveness": 0.92
  }
}
```

---

## PERFORMANCE TARGETS

| Component | Target | Measurement |
|-----------|--------|-------------|
| XML Generation | < 5% overhead vs Plus/Minus | Benchmarked on 10K file repo |
| CDATA Escaping | O(n) string scan | Single pass replacement |
| Metadata Injection | < 1ms | Pre-computed during file walk |
| Frozen Mode | 0ms store access | Complete bypass |

---

## VALIDATION METRICS

### Success Criteria:
1. **Format Validity**: 100% valid XML output (xmllint passes)
2. **CDATA Safety**: Handles all `]]>` sequences correctly
3. **Determinism**: `--frozen` produces byte-identical output
4. **Privacy**: Default output contains no PII

### Testing Protocol:
1. Create test vectors with known edge cases
2. Validate XML structure with schema
3. Test CDATA escaping with adversarial inputs
4. Verify frozen mode reproducibility

---

## WASM USAGE

The pm_encoder Rust engine compiles to WebAssembly, enabling browser-based tooling.

### Building for WASM

```bash
# Build the library for WASM (no std::fs access)
cargo build --target wasm32-unknown-unknown --lib

# Build with wasm-pack for npm distribution
wasm-pack build --target web --features wasm
```

### Browser Integration

```javascript
import init, { ContextEngine, EncoderConfig } from 'pm_encoder';

async function serializeContext(files) {
    await init();

    const config = EncoderConfig.new()
        .with_format('claude-xml')
        .with_frozen(true);

    const engine = ContextEngine.with_config(config);

    // Files must be provided as an array of {path, content} objects
    // since browser cannot access filesystem
    return engine.serialize_files(files);
}
```

### Architecture Note

The core `ContextEngine` is designed with a clean separation between:
- **Pure computation** (serialization, truncation, prioritization)
- **I/O operations** (file walking, filesystem access)

This "Library-First" design means the core can be embedded in:
- CLI tools (with walkdir for filesystem access)
- Browser applications (with files provided via API)
- MCP servers (with stdio transport)
- VS Code extensions (with workspace API)

---

## IRON MOLD STATUS

These specifications are **IMPLEMENTED** in rust-v1.0.0.

**Implemented in rust-v1.0.0:**
- [x] `OutputFormat::ClaudeXml` enum variant
- [x] Streaming `XmlWriter<W: Write>` for O(1) memory
- [x] CDATA escaping for `]]>` sequences
- [x] `--frozen` flag for deterministic output
- [x] `--allow-sensitive` flag for privacy control
- [x] Full metadata injection with attention_map
- [x] Zoom affordances in truncation markers
- [x] `--zoom` CLI with fn/class/mod/file targets
- [x] MCP `zoom_context` tool
- [x] WASM compatibility (compiles to wasm32-unknown-unknown)

**Test Coverage:**
- 267 tests passing (235 unit + 29 integration + 3 doc)
- 28 CLI integration tests covering all major flags
- XML validation with xmllint

---

**Document Status:** IMPLEMENTED
**Spec Version:** 1.0
**Created:** 2025-12-20
**Implemented:** 2025-12-20 (rust-v1.0.0)
