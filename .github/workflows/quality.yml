name: Quality Assurance

on:
  push:
    branches: [ main, develop, claude/* ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    name: Test Suite (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: ["3.6", "3.7", "3.8", "3.9", "3.10", "3.11", "3.12"]

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install coverage

    - name: Run tests
      run: |
        python -m unittest discover -s tests -p 'test_*.py' -v

    - name: Check version output
      run: |
        ./pm_encoder.py --version

    - name: Test self-serialization
      run: |
        ./pm_encoder.py . -o /tmp/test_output.txt
        head -1 /tmp/test_output.txt | grep -q '++++++++++' || exit 1

  coverage:
    name: Coverage Analysis
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install coverage

    - name: Run coverage
      run: |
        python -m coverage run -m unittest discover -s tests -p 'test_*.py'
        python -m coverage report -m
        python -m coverage html

    - name: Check coverage threshold (98%)
      run: |
        python -m coverage report --fail-under=98 || echo "Warning: Coverage below 98% threshold"

    - name: Upload coverage artifacts
      uses: actions/upload-artifact@v3
      with:
        name: coverage-report
        path: htmlcov/

  lint:
    name: Code Quality Checks
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Python syntax check
      run: |
        python -m py_compile pm_encoder.py
        python -m py_compile tests/test_pm_encoder.py

    - name: Check for TODOs in critical files
      run: |
        ! grep -n "TODO\|FIXME" pm_encoder.py | grep -v "# TODO:" || echo "TODOs found (non-blocking)"

  integration:
    name: Integration Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Test architecture lens
      run: |
        ./pm_encoder.py . --lens architecture --truncate 100 -o /tmp/arch.txt
        grep -q "\.pm_encoder_meta" /tmp/arch.txt || exit 1

    - name: Test structure mode
      run: |
        ./pm_encoder.py . --truncate-mode structure -o /tmp/struct.txt
        grep -q "STRUCTURE MODE" /tmp/struct.txt || exit 1

    - name: Test Rust support
      run: |
        mkdir -p /tmp/rust_test
        echo 'fn main() { println!("test"); }' > /tmp/rust_test/main.rs
        ./pm_encoder.py /tmp/rust_test --truncate-mode structure -o /tmp/rust_output.txt
        grep -q "fn main" /tmp/rust_output.txt || exit 1

  performance:
    name: Performance Benchmarks
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Benchmark self-serialization
      run: |
        time timeout 10s ./pm_encoder.py . -o /tmp/benchmark.txt || exit 1
        echo "Self-serialization completed within timeout"

    - name: Check output size
      run: |
        OUTPUT_SIZE=$(wc -l < /tmp/benchmark.txt)
        echo "Output lines: $OUTPUT_SIZE"
        [ "$OUTPUT_SIZE" -gt 0 ] || exit 1
