name: Quality Assurance

on:
  push:
    branches: [ main, develop, claude/* ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    name: Rust Test Suite
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable

    - name: Cache cargo
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          rust/target/
        key: ${{ runner.os }}-cargo-${{ hashFiles('rust/Cargo.lock') }}

    - name: Run tests
      working-directory: rust
      run: cargo test --release

    - name: Check version output
      working-directory: rust
      run: |
        cargo build --release
        ./target/release/vo --version

  lint:
    name: Code Quality Checks
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        components: clippy, rustfmt

    - name: Check formatting
      working-directory: rust
      run: cargo fmt --check

    - name: Run clippy
      working-directory: rust
      run: cargo clippy -- -W clippy::all

  integration:
    name: Integration Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable

    - name: Build release binary
      working-directory: rust
      run: cargo build --release

    - name: Test self-serialization
      working-directory: rust
      run: |
        ./target/release/vo . -o /tmp/test_output.txt
        head -1 /tmp/test_output.txt | grep -q '+++' || exit 1

    - name: Test architecture lens
      working-directory: rust
      run: |
        ./target/release/vo . --lens architecture -o /tmp/arch.txt
        [ -s /tmp/arch.txt ] || exit 1

    - name: Test Rust file analysis
      run: |
        mkdir -p /tmp/rust_test
        echo 'fn main() { println!("test"); }' > /tmp/rust_test/main.rs
        ./rust/target/release/vo /tmp/rust_test -o /tmp/rust_output.txt
        grep -q "fn main" /tmp/rust_output.txt || exit 1

  performance:
    name: Performance Benchmarks
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable

    - name: Build release binary
      working-directory: rust
      run: cargo build --release

    - name: Benchmark self-serialization
      working-directory: rust
      run: |
        time timeout 10s ./target/release/vo . -o /tmp/benchmark.txt || exit 1
        echo "Self-serialization completed within timeout"

    - name: Check output size
      run: |
        OUTPUT_SIZE=$(wc -l < /tmp/benchmark.txt)
        echo "Output lines: $OUTPUT_SIZE"
        [ "$OUTPUT_SIZE" -gt 0 ] || exit 1
